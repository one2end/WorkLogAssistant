<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', sans-serif;
  background: transparent;
  overflow: hidden;
  user-select: none;
}
.float-widget {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 8px 6px 12px;
  background: var(--float-bg, rgba(13, 13, 13, 0.92));
  border: 1px solid var(--float-border, rgba(100, 255, 218, 0.3));
  border-radius: 20px;
  backdrop-filter: blur(10px);
  cursor: grab;
  transition: background 0.2s, border-color 0.2s;
  height: 100%;
}
.float-widget:hover {
  border-color: var(--float-border-hover, rgba(100, 255, 218, 0.6));
  background: var(--float-bg-hover, rgba(13, 13, 13, 0.96));
}
.float-widget:active { cursor: grabbing; }
.dot { width:6px;height:6px;border-radius:50%;background:#6b7280;flex-shrink:0 }
.info { display:flex; align-items:center; gap:6px; flex:1; min-width:0; }
</style>
</head>
<body>
<div class="float-widget" id="widget">
  <div class="dot" id="dot"></div>
  <div class="info" id="info">
    <span id="appName" style="font-size:12px;color:var(--float-text,#e8e8e8);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0">--</span>
    <span id="duration" style="font-size:11px;color:var(--float-accent,#64ffda);font-weight:600;white-space:nowrap"></span>
  </div>
  <button id="toggleBtn" style="border:none;border-radius:50%;width:20px;height:20px;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;background:rgba(107,114,128,0.3);color:#9ca3af;transition:all 0.2s;flex-shrink:0" title="开关记录">⏸</button>
  <span id="resizeHandle" style="cursor:ew-resize;padding:0 3px;font-size:10px;color:var(--float-text,#888);opacity:0.4">⋮</span>
</div>
<script>
const { ipcRenderer } = require('electron');
let monitoring = false;

// --- Drag & double-click logic ---
let dragging = false, dragStartX = 0, dragStartY = 0, winStartX = 0, winStartY = 0;
let clickTimer = null, clickCount = 0;
const DRAG_THRESHOLD = 4;

const widget = document.getElementById('widget');

widget.addEventListener('mousedown', (e) => {
  if (e.target.id === 'toggleBtn' || e.target.id === 'resizeHandle') return;
  if (resizing) return;
  dragging = false;
  dragStartX = e.screenX;
  dragStartY = e.screenY;
  ipcRenderer.invoke('get-float-bounds').then(b => {
    winStartX = b.x; winStartY = b.y;
  });

  const onMove = (ev) => {
    if (resizing) return;
    const dx = ev.screenX - dragStartX, dy = ev.screenY - dragStartY;
    if (!dragging && (Math.abs(dx) > DRAG_THRESHOLD || Math.abs(dy) > DRAG_THRESHOLD)) {
      dragging = true;
    }
    if (dragging) {
      ipcRenderer.invoke('set-float-pos', winStartX + dx, winStartY + dy);
    }
  };
  const onUp = () => {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    if (!dragging) {
      clickCount++;
      if (clickCount === 1) {
        clickTimer = setTimeout(() => { clickCount = 0; }, 300);
      } else if (clickCount === 2) {
        clearTimeout(clickTimer);
        clickCount = 0;
        ipcRenderer.invoke('show-main-window');
      }
    }
    dragging = false;
  };
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
  e.preventDefault();
});

// --- Toggle button ---
document.getElementById('toggleBtn').addEventListener('click', () => {
  ipcRenderer.invoke('toggle-monitoring').then(s => { monitoring = s; updateUI(); });
});

// --- Resize handle ---
const handle = document.getElementById('resizeHandle');
let resizing = false, rStartX, rStartW;
handle.addEventListener('mousedown', (e) => {
  resizing = true; rStartX = e.screenX;
  ipcRenderer.invoke('get-float-bounds').then(b => { rStartW = b.width; });
  e.preventDefault(); e.stopPropagation();
});
document.addEventListener('mousemove', (e) => {
  if (!resizing) return;
  const nw = Math.max(180, Math.min(500, rStartW + e.screenX - rStartX));
  ipcRenderer.invoke('set-float-width', nw);
});
document.addEventListener('mouseup', () => {
  if (resizing) { resizing = false; ipcRenderer.invoke('save-float-width'); }
});

// --- Theme ---
const themeMap = {
  dark: { '--float-bg':'rgba(13,13,13,0.92)','--float-border':'rgba(100,255,218,0.3)','--float-border-hover':'rgba(100,255,218,0.6)','--float-bg-hover':'rgba(13,13,13,0.96)','--float-accent':'#64ffda','--float-text':'#e8e8e8' },
  light: { '--float-bg':'rgba(255,255,255,0.92)','--float-border':'rgba(13,110,253,0.3)','--float-border-hover':'rgba(13,110,253,0.6)','--float-bg-hover':'rgba(255,255,255,0.96)','--float-accent':'#0d6efd','--float-text':'#212529' },
  ocean: { '--float-bg':'rgba(13,33,55,0.92)','--float-border':'rgba(79,195,247,0.3)','--float-border-hover':'rgba(79,195,247,0.6)','--float-bg-hover':'rgba(13,33,55,0.96)','--float-accent':'#4fc3f7','--float-text':'#d4e4f7' },
  forest: { '--float-bg':'rgba(30,54,32,0.92)','--float-border':'rgba(129,199,132,0.3)','--float-border-hover':'rgba(129,199,132,0.6)','--float-bg-hover':'rgba(30,54,32,0.96)','--float-accent':'#81c784','--float-text':'#d4e8d0' },
  rose: { '--float-bg':'rgba(58,31,46,0.92)','--float-border':'rgba(244,143,177,0.3)','--float-border-hover':'rgba(244,143,177,0.6)','--float-bg-hover':'rgba(58,31,46,0.96)','--float-accent':'#f48fb1','--float-text':'#f0d4e0' }
};
function applyTheme(t) {
  const v = themeMap[t] || themeMap.dark;
  for (const [k,val] of Object.entries(v)) document.documentElement.style.setProperty(k,val);
}

// --- UI update ---
function updateUI() {
  const dot = document.getElementById('dot');
  const btn = document.getElementById('toggleBtn');
  if (monitoring) {
    dot.style.background='#10b981';
    btn.textContent='⏸'; btn.style.background='rgba(16,185,129,0.25)'; btn.style.color='#10b981'; btn.title='暂停记录';
  } else {
    dot.style.background='#6b7280';
    btn.textContent='▶'; btn.style.background='rgba(107,114,128,0.3)'; btn.style.color='#9ca3af'; btn.title='开始记录';
  }
}

// --- IPC listeners ---
ipcRenderer.on('float-update', (e, data) => {
  document.getElementById('appName').textContent = data.appName || '--';
  document.getElementById('duration').textContent = data.duration || '';
  if (data.isMonitoring !== undefined && data.isMonitoring !== monitoring) { monitoring = data.isMonitoring; updateUI(); }
});
ipcRenderer.on('float-monitoring-status', (e, s) => { monitoring = s; updateUI(); });
ipcRenderer.on('float-theme', (e, t) => applyTheme(t));
</script>
</body>
</html>
